# Simplified POS Workflow - Документация ✅

## Упрощенный workflow: Scan → Sell

Это упрощенная система кассы, где кассир **просто сканирует товары и нажимает кнопку продажи**. Никаких дополнительных действий не требуется.

---

## 🎯 Основная концепция

**Пользователь должен:**
1. Сканировать штрихкод товара
2. Нажать кнопку "Bajarildi" (Продать)
3. Готово! ✅

**Никаких других действий не нужно:**
- ❌ Не нужно создавать продажу вручную
- ❌ Не нужно добавлять товары вручную
- ❌ Не нужно вводить данные клиента (опционально)
- ❌ Не нужно выбирать партии
- ✅ Просто сканируй и продавай!

---

## 📋 API Endpoints

### 1. POST `/api/sales/scan-item/`
**Сканировать товар** - автоматически создает или обновляет черновик продажи

**Request:**
```json
{
  "barcode": "1234567890123",
  "session": 1,
  "quantity": 1  // Опционально, по умолчанию 1
}
```

**Response:**
```json
{
  "status": "success",
  "message": "Товар добавлен в корзину",
  "data": {
    "sale": {
      "id": 15,
      "session": 1,
      "status": "pending",
      "receipt_number": null,
      "total_amount": "150000.00",
      "items": [
        {
          "id": 23,
          "product": 18,
          "product_name": "Test Futbolka",
          "quantity": "2.000",
          "unit_price": "75000.00",
          "total": "150000.00"
        }
      ]
    },
    "item_added": {
      "product_id": 18,
      "product_name": "Test Futbolka",
      "quantity": 1,
      "unit_price": 75000.00
    }
  }
}
```

**Что происходит:**
- Если нет pending продажи для сессии → создается новая
- Если есть pending продажа → добавляется товар в нее
- Если товар уже в корзине → увеличивается количество
- Автоматически списывается со склада при завершении

---

### 2. GET `/api/sales/current/?session={session_id}`
**Получить текущую корзину** - pending продажа для текущей сессии

**Request:**
```
GET /api/sales/current/?session=1
```

**Response:**
```json
{
  "status": "success",
  "data": {
    "sale": {
      "id": 15,
      "session": 1,
      "status": "pending",
      "total_amount": "150000.00",
      "items": [...]
    }
  }
}
```

**Если нет pending продажи:**
```json
{
  "status": "success",
  "data": {
    "sale": null
  }
}
```

---

### 3. POST `/api/sales/{sale_id}/add-item/`
**Добавить товар вручную** (без штрихкода)

**Request:**
```json
{
  "product": 18,
  "quantity": 2  // Опционально, по умолчанию 1
}
```

**Response:**
```json
{
  "status": "success",
  "message": "Товар добавлен",
  "data": {
    "sale": {...}
  }
}
```

---

### 4. DELETE `/api/sales/{sale_id}/remove-item/`
**Удалить товар из корзины**

**Request:**
```json
{
  "product": 18
}
```

**Response:**
```json
{
  "status": "success",
  "message": "Товар удален",
  "data": {
    "sale": {...}
  }
}
```

---

### 5. POST `/api/sales/{sale_id}/checkout/`
**Завершить продажу** - принять оплату и закрыть продажу

**Request:**
```json
{
  "payments": [
    {
      "method": "cash",  // "cash" | "card" | "transfer"
      "amount": 150000
    }
  ],
  "customer_name": "Иван",  // Опционально
  "customer_phone": "+998901234567"  // Опционально
}
```

**Response:**
```json
{
  "status": "success",
  "message": "Продажа завершена",
  "data": {
    "sale": {
      "id": 15,
      "status": "completed",
      "receipt_number": "RECEIPT_20251117_ABC123",
      "total_amount": 150000,
      ...
    },
    "receipt_number": "RECEIPT_20251117_ABC123",
    "total_amount": 150000,
    "change_amount": 0  // Сдача (если наличными)
  }
}
```

**Что происходит:**
- Товар списывается со склада
- Статус меняется на "completed"
- Генерируется номер чека автоматически
- Создаются платежи
- Возвращается чек

---

## 🔄 Workflow диаграмма

```
┌─────────────────────────────────────────────────────────┐
│                   ОТКРЫТА СМЕНА                         │
│                   session_id = 1                        │
└─────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────┐
│  1. СКАНИРОВАНИЕ ТОВАРА                                 │
│  POST /api/sales/scan-item/                            │
│  { barcode: "123", session: 1 }                        │
└─────────────────────────────────────────────────────────┘
                           │
                           ▼
            ┌──────────────────────────┐
            │ Есть pending продажа?    │
            └──────────────────────────┘
                  /              \
               НЕТ              ДА
                /                  \
               ▼                    ▼
    ┌──────────────────┐   ┌──────────────────┐
    │ Создать новую    │   │ Добавить в       │
    │ pending продажу  │   │ существующую     │
    └──────────────────┘   └──────────────────┘
                \                  /
                 \                /
                  ▼              ▼
┌─────────────────────────────────────────────────────────┐
│  2. АВТООБНОВЛЕНИЕ КОРЗИНЫ                              │
│  GET /api/sales/current/?session=1                     │
│  Корзина обновляется каждые 5 секунд                   │
└─────────────────────────────────────────────────────────┘
                           │
                  (Сканируем еще товары)
                           │
                           ▼
┌─────────────────────────────────────────────────────────┐
│  3. НАЖАТЬ "Bajarildi"                                  │
│  POST /api/sales/{sale_id}/checkout/                   │
│  { payments: [{ method: "cash", amount: 150000 }] }    │
└─────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────┐
│  4. ПРОДАЖА ЗАВЕРШЕНА ✅                                │
│  - Товар списан со склада                               │
│  - Статус: completed                                    │
│  - Чек сгенерирован                                     │
│  - Корзина очищена                                      │
└─────────────────────────────────────────────────────────┘
```

---

## 💻 Реализация на фронтенде

### Файловая структура

```
src/
├── entities/sales/
│   ├── api/
│   │   └── salesApi.ts           # API методы (добавлены новые)
│   └── model/
│       ├── types.ts               # Типы (добавлены новые)
│       └── useSimplifiedPOS.ts    # 🆕 Хуки для POS
│
└── pages/Home/
    └── ui/
        ├── index.tsx              # 🔄 Упрощенный POS компонент
        └── index.tsx.old          # Старая версия (backup)
```

---

### Новые хуки

**Файл:** `src/entities/sales/model/useSimplifiedPOS.ts`

#### 1. `useScanItem()` - Сканировать товар

```typescript
import { useScanItem } from "@/entities/sales/model/useSimplifiedPOS";

const scanItem = useScanItem();

// Использование
scanItem.mutate(
  { barcode: "1234567890123", session: 1 },
  {
    onSuccess: (data) => {
      console.log("Товар добавлен:", data.data.item_added);
    },
    onError: (error) => {
      console.error("Ошибка:", error);
    }
  }
);
```

#### 2. `useCurrentSale()` - Получить текущую корзину

```typescript
import { useCurrentSale } from "@/entities/sales/model/useSimplifiedPOS";

const currentSale = useCurrentSale(sessionId);

// Данные
const sale = currentSale.data?.data?.sale;
const items = sale?.items || [];
const totalAmount = sale?.total_amount || "0";

// Автоматически обновляется каждые 5 секунд
```

#### 3. `useRemoveItemFromSale()` - Удалить товар

```typescript
import { useRemoveItemFromSale } from "@/entities/sales/model/useSimplifiedPOS";

const removeItem = useRemoveItemFromSale();

// Использование
removeItem.mutate({
  saleId: 15,
  data: { product: 18 }
});
```

#### 4. `useCheckout()` - Завершить продажу

```typescript
import { useCheckout } from "@/entities/sales/model/useSimplifiedPOS";

const checkout = useCheckout();

// Использование
checkout.mutate({
  saleId: 15,
  data: {
    payments: [
      { method: "cash", amount: 150000 }
    ]
  }
});
```

---

### Упрощенный компонент Home

**Основные изменения:**

**Было (старый код):**
- 680 строк кода
- Ручное управление продуктами в state
- 4-шаговое создание продажи
- Выбор клиента
- Гибридные платежи
- Сложная логика

**Стало (новый код):**
- 320 строк кода
- Автоматическое управление через API
- 1-шаговое сканирование + продажа
- Опциональный клиент
- Простые платежи (cash/card/transfer)
- Простая логика

**Удалено:**
- ❌ Состояние `products` (теперь в API)
- ❌ Ручной выбор товаров
- ❌ Модальное окно клиента (упрощено)
- ❌ Гибридные платежи (оставлены базовые)
- ❌ 4-шаговое создание продажи

**Добавлено:**
- ✅ `useCurrentSale()` - автоматическая корзина
- ✅ `useScanItem()` - сканирование
- ✅ `useCheckout()` - одна кнопка продажи
- ✅ Автообновление каждые 5 секунд

---

## 🎨 UI/UX

### Основной экран

```
┌────────────────────────────────────────────┐
│  Kassa                           [X Clear] │
├────────────────────────────────────────────┤
│  Смена: Открыта | 12:34 - ...             │
├────────────────────────────────────────────┤
│                                            │
│  # │ Kategoriya │ Tovar │ SKU │ Soni │ Narx│
│  ──────────────────────────────────────────│
│  1 │ Одежда     │ Футб. │ ... │ 2x   │ 150k│
│  2 │ Обувь      │ Крос. │ ... │ 1x   │ 200k│
│                                            │
│  [Empty state if no items]                 │
│                                            │
├────────────────────────────────────────────┤
│  Mahsulotlar soni: 3                       │
└────────────────────────────────────────────┘

┌────────────────┐
│ Umumiy summa:  │
│ 350,000 uzs    │
├────────────────┤
│ Способ оплаты: │
│ [ Naqd  ]      │
│ [ Karta ]      │
│ [O'tkazma]     │
├────────────────┤
│  [Bajarildi]   │  ← ОДНА КНОПКА!
└────────────────┘
```

### Процесс использования

1. **Открыть смену** (если еще не открыта)
2. **Сканировать товары** (штрихкод-сканером)
   - Каждое сканирование автоматически добавляет товар
   - Корзина обновляется в реальном времени
3. **Выбрать способ оплаты** (Naqd/Karta/O'tkazma)
4. **Нажать "Bajarildi"**
5. **Готово!** ✅

---

## 🔍 Как это работает под капотом

### 1. Сканирование товара

```typescript
// Пользователь сканирует штрихкод
handleScan("1234567890123")

// ↓ Вызывается API
POST /api/sales/scan-item/
{
  "barcode": "1234567890123",
  "session": 1
}

// ↓ Backend проверяет:
// - Есть ли товар с таким barcode?
// - Есть ли pending продажа для session=1?

// ↓ Если pending продажи нет:
// - Создает новую продажу (status: "pending")
// - Добавляет товар в нее

// ↓ Если pending продажа есть:
// - Добавляет товар в существующую

// ↓ Frontend автоматически обновляет корзину
useCurrentSale(1) // Каждые 5 секунд
```

### 2. Автообновление корзины

```typescript
const currentSale = useCurrentSale(sessionId);

// React Query настроен на автообновление:
refetchInterval: 5000  // Каждые 5 секунд

// Корзина всегда актуальна!
const items = currentSale.data?.data?.sale?.items || [];
```

### 3. Завершение продажи

```typescript
// Пользователь нажимает "Bajarildi"
handleCheckout()

// ↓ Вызывается API
POST /api/sales/15/checkout/
{
  "payments": [
    { "method": "cash", "amount": 350000 }
  ]
}

// ↓ Backend:
// - Списывает товар со склада
// - Меняет status: "pending" → "completed"
// - Генерирует receipt_number
// - Создает платежи
// - Возвращает чек

// ↓ Frontend:
// - Показывает уведомление "Muvaffaqiyat"
// - Очищает корзину (автоматически, т.к. pending продажи больше нет)
// - Готов к следующей продаже
```

---

## ⚙️ Настройка и запуск

### 1. Убедитесь что файлы обновлены

```bash
# API
src/entities/sales/api/salesApi.ts        # Добавлены новые endpoints
src/entities/sales/model/types.ts         # Добавлены новые типы

# Hooks
src/entities/sales/model/useSimplifiedPOS.ts  # 🆕 Новый файл

# Components
src/pages/Home/ui/index.tsx               # 🔄 Упрощенная версия
src/pages/Home/ui/index.tsx.old           # Backup старой версии
```

### 2. Запустите фронтенд

```bash
npm run dev
```

### 3. Откройте кассу

```
http://localhost:3110/
```

### 4. Откройте смену

1. Перейти в настройки смены (если еще не открыта)
2. Открыть смену
3. Вернуться на главную страницу

### 5. Используйте!

1. Сканируйте штрихкод
2. Смотрите как товар появляется в корзине
3. Нажмите "Bajarildi"
4. Готово! ✅

---

## 🧪 Тестирование

### Сценарий 1: Базовый flow

```
1. Открыть смену
   ✓ GET /api/sessions/current/

2. Сканировать товар
   ✓ POST /api/sales/scan-item/
   ✓ Товар появился в корзине
   ✓ Сумма обновилась

3. Сканировать еще товар
   ✓ POST /api/sales/scan-item/
   ✓ Количество товаров: 2
   ✓ Сумма обновилась

4. Завершить продажу
   ✓ POST /api/sales/{id}/checkout/
   ✓ Уведомление "Muvaffaqiyat"
   ✓ Корзина очищена
   ✓ Готов к следующей продаже
```

### Сценарий 2: Ошибки

```
1. Сканировать несуществующий barcode
   ✓ Ошибка: "Mahsulot topilmadi"

2. Нажать "Bajarildi" с пустой корзиной
   ✓ Модальное окно: "Avval kassaga mahsulot qo'shing"

3. Сканировать без открытой смены
   ✓ Ошибка: "Iltimos, avval smenani oching!"
```

### Сценарий 3: Удаление товаров

```
1. Сканировать 3 товара
   ✓ Корзина: 3 товара

2. Удалить 1 товар (кнопка delete)
   ✓ DELETE /api/sales/{id}/remove-item/
   ✓ Корзина: 2 товара
   ✓ Сумма обновилась

3. Очистить все (кнопка X)
   ✓ DELETE вызывается для каждого товара
   ✓ Корзина пуста
```

---

## 📝 Важные замечания

### 1. Автообновление

Корзина автоматически обновляется каждые 5 секунд:
```typescript
refetchInterval: 5000
```

Это гарантирует, что данные всегда актуальны, даже если:
- Другой пользователь сканирует товары на этой же сессии
- Backend изменил данные
- Произошла ошибка сети

### 2. Только одна pending продажа

Для каждой сессии может быть только **одна pending продажа**:
- При сканировании создается новая pending продажа (если нет)
- Все последующие сканирования добавляют товары в эту же продажу
- После checkout статус меняется на "completed"
- Следующее сканирование создаст новую pending продажу

### 3. Receipt number генерируется автоматически

Не нужно передавать `receipt_number` в запросе:
```typescript
// ❌ НЕ НУЖНО
{ receipt_number: "RECEIPT_001" }

// ✅ ПРАВИЛЬНО
{ } // Backend сам сгенерирует
```

Формат: `RECEIPT_YYYYMMDD_XXXXXX`

### 4. Барcode должен существовать

Backend проверяет barcode в таблице Products:
```sql
SELECT * FROM products WHERE barcode = '1234567890123'
```

Если не найден → ошибка 404

### 5. Session должна быть открыта

Нельзя сканировать товары без открытой смены:
```typescript
if (!sessionId) {
  // Ошибка: "Iltimos, avval smenani oching!"
}
```

---

## 🆚 Сравнение: Старый vs Новый

| Критерий | Старый workflow | Новый workflow |
|----------|-----------------|----------------|
| **Шаги** | 4 шага (create → add items → add payments → complete) | 1 шаг (scan) + 1 кнопка (checkout) |
| **Код** | 680 строк | 320 строк |
| **State** | Ручное управление products[] | Автоматически через API |
| **Клиент** | Обязательный выбор | Опциональный |
| **Платежи** | Гибридные, сложные | Простые (cash/card/transfer) |
| **Товары** | Ручной выбор из списка | Автоматически по barcode |
| **Обновление** | Вручную | Автоматически каждые 5 сек |
| **Сложность** | Высокая | Низкая |
| **Скорость** | Медленно | Быстро |

---

## ✅ Итого

**Упрощенный POS готов!** 🎉

- ✅ API endpoints добавлены
- ✅ Типы обновлены
- ✅ Хуки созданы
- ✅ Компонент упрощен
- ✅ Документация готова

**Теперь кассир может:**
1. Сканировать товары
2. Нажать "Bajarildi"
3. Готово! ✨

**Никаких других действий не требуется!**

---

_Создано: 2025-01-17_
_Автор: Claude Code_
_Версия: 1.0_
